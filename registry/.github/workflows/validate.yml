name: Validate Registry

on:
  pull_request:
    paths:
      - 'index.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: python3 -m json.tool index.json > /dev/null

      - name: Install jsonschema validator
        run: pip install jsonschema

      - name: Validate against schema
        run: |
          python3 -c "
          import json, jsonschema
          with open('schema.json') as s:
              schema = json.load(s)
          with open('index.json') as f:
              data = json.load(f)
          jsonschema.validate(data, schema)
          print(f'Valid: {len(data)} entries')
          "

      - name: Check for duplicate IDs
        run: |
          python3 -c "
          import json
          with open('index.json') as f:
              data = json.load(f)
          ids = [e['id'] for e in data]
          dupes = [i for i in ids if ids.count(i) > 1]
          if dupes:
              raise ValueError(f'Duplicate IDs: {set(dupes)}')
          print(f'No duplicates in {len(ids)} entries')
          "

      - name: Check source URLs are reachable
        run: |
          python3 -c "
          import json, urllib.request
          with open('index.json') as f:
              data = json.load(f)
          for entry in data:
              source = entry['source']
              parts = source.split('@')
              repo = parts[0]
              tag = parts[1] if len(parts) > 1 else 'latest'
              if tag == 'latest':
                  url = f'https://github.com/{repo}/releases/latest'
              else:
                  url = f'https://github.com/{repo}/releases/tag/{tag}'
              try:
                  req = urllib.request.Request(url, method='HEAD')
                  resp = urllib.request.urlopen(req, timeout=10)
                  print(f'  OK: {source} -> {resp.status}')
              except Exception as e:
                  print(f'  WARN: {source} -> {e} (may not exist yet)')
          "
